<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Artwork Information Submission</title>
    <link rel="stylesheet" href="home-styles.css" />
    <style>
      .form-section{padding:var(--space-3xl) 0;background:var(--elev-1);border-bottom:1px solid var(--elev-2)}
      .form-card{max-width:960px;margin:0 auto;background:var(--elev-1);border:1px solid var(--elev-2);
        border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md);padding:var(--space-xl)}
      .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-lg)}
      .form-row{display:flex;flex-direction:column;gap:var(--space-xs)}
      .form-row.full{grid-column:1 / -1}
      .label{font-size:var(--font-size-sm);color:var(--muted)}
      .input,.select,.textarea{padding:var(--space-sm) var(--space-md);background:var(--elev-2);border:1px solid var(--accent);
        border-radius:var(--border-radius);color:var(--text);transition:border-color var(--transition-fast)}
      .textarea{min-height:140px;resize:vertical}
      .input:focus,.select:focus,.textarea:focus{border-color:var(--focus);outline:none}
      .form-actions{display:flex;gap:var(--space-md);margin-top:var(--space-lg)}
      .hint{color:var(--muted);font-size:var(--font-size-sm)}
      .disabled-note{color:var(--muted);font-size:var(--font-size-sm);margin-top:4px}
      
      /* Popup notification styles */
      .notification-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);
        display:flex;align-items:center;justify-content:center;z-index:9999;animation:fadeIn 0.2s ease}
      .notification-popup{background:var(--elev-1);padding:var(--space-xl);border-radius:var(--border-radius-lg);
        max-width:500px;width:90%;box-shadow:var(--shadow-xl);animation:slideUp 0.3s ease;text-align:center}
      .notification-icon{font-size:48px;margin-bottom:var(--space-md)}
      .notification-title{font-size:var(--font-size-xl);font-weight:600;margin-bottom:var(--space-sm)}
      .notification-message{color:var(--muted);margin-bottom:var(--space-lg)}
      .notification-success .notification-title{color:#8dc891}
      .notification-error .notification-title{color:#e06c75}
      @keyframes fadeIn{from{opacity:0}to{opacity:1}}
      @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    </style>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to content</a>
    <header class="header" role="banner">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <a href="home.html" class="logo-link"><h1 class="logo-text">Indigenous Art Atlas</h1></a>
          </div>
          <nav class="nav" role="navigation" aria-label="Main navigation">
            <ul class="nav-list">
              <li><a href="home.html#map-section" class="nav-link">Map</a></li>
              <li><a href="search.html" class="nav-link">Search</a></li>
              <li><a href="about.html" class="nav-link">About Us</a></li>
              <li><a href="register.html" class="nav-link">Register</a></li>
            </ul>

            <!-- User Authentication Section -->
            <div class="auth-section">
              <!-- Login Button (shown when not logged in) -->
              <div id="login-section" class="login-section-nav">
                <a href="login.html" class="btn btn-primary login-nav-btn">Login</a>
              </div>

              <!-- User Avatar (shown when logged in) -->
              <div id="user-section" class="user-avatar" style="display: none">
                <div class="avatar-container">
                  <img
                    id="user-avatar-image"
                    src="assets/img/user-avatar.png"
                    alt="User avatar"
                    class="avatar-image"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                  />
                  <div class="avatar-fallback">
                    <span id="user-avatar-initials" class="avatar-initials">TU</span>
                  </div>
                  <span id="user-display-name" class="user-name">Test User</span>
                  <button
                    id="logout-btn"
                    class="logout-btn"
                    title="Logout"
                    aria-label="Logout"
                  >
                    <span class="logout-icon">⏻</span>
                  </button>
                </div>
              </div>
            </div>
          </nav>
        </div>
      </div>
    </header>

    <main id="main-content" role="main">
      <section class="search-header">
        <div class="container">
          <h1 class="page-title" id="page-title">Artwork Information Submission</h1>
          <p class="page-description" id="page-description">Only <strong>approved artists</strong> can submit artworks. Submissions are reviewed by admins before publication.</p>
        </div>
      </section>

      <section class="form-section">
        <div class="container">
          <div class="form-card">
            <form id="artwork-form" novalidate>
              <div class="form-grid">
                <div class="form-row">
                  <label class="label" for="title">Title *</label>
                  <input id="title" class="input" type="text" required placeholder="e.g., Caring for Country" />
                </div>

                <div class="form-row">
                  <label class="label" for="artType">Art Type *</label>
                  <select id="artType" class="select" required>
                    <option value="Portrait">Portrait</option>
                    <option value="Painting">Painting</option>
                    <option value="Installation">Installation</option>
                    <option value="Sound Installation">Sound Installation</option>
                    <option value="Glass Installation">Glass Installation</option>
                    <option value="Cave Art">Cave Art</option>
                    <option value="Mural">Mural</option>
                    <option value="Gallery Piece">Gallery Piece</option>
                    <option value="Rock Painting">Rock Painting</option>
                    <option value="Sculpture">Sculpture</option>
                  </select>
                </div>

                <div class="form-row">
                  <label class="label" for="period">Period *</label>
                  <select id="period" class="select" required>
                    <option value="Ancient">Ancient</option>
                    <option value="Contemporary">Contemporary</option>
                  </select>
                </div>

                <div class="form-row">
                  <label class="label" for="region">Region *</label>
                  <select id="region" class="select" required>
                    <option value="NSW">NSW</option><option value="VIC">VIC</option>
                    <option value="QLD">QLD</option><option value="SA">SA</option>
                    <option value="WA">WA</option><option value="NT">NT</option>
                    <option value="TAS">TAS</option><option value="ACT">ACT</option>
                  </select>
                </div>

                <div class="form-row">
                  <label class="label" for="sensitive">Sensitive *</label>
                  <select id="sensitive" class="select" required>
                    <option value="false" selected>false</option>
                    <option value="true">true</option>
                  </select>
                  <p class="hint">If <strong>true</strong>, the address must not be provided.</p>
                </div>

                <div class="form-row full">
                  <label class="label" for="address">Address (optional)</label>
                  <input id="address" class="input" type="text" placeholder="e.g., 123 King William St, Adelaide SA"/>
                  <p class="disabled-note" id="address-note" style="display:none;">Address disabled because the artwork is marked as sensitive.</p>
                </div>

                <div class="form-row">
                  <label class="label" for="latitude">Latitude (optional)</label>
                  <input id="latitude" class="input" type="number" step="0.000001" min="-90" max="90" placeholder="e.g., -34.9285"/>
                  <p class="hint">Decimal degrees. Leave empty to use region center.</p>
                </div>

                <div class="form-row">
                  <label class="label" for="longitude">Longitude (optional)</label>
                  <input id="longitude" class="input" type="number" step="0.000001" min="-180" max="180" placeholder="e.g., 138.6007"/>
                  <p class="disabled-note" id="coords-note" style="display:none;">Coordinates disabled because the artwork is marked as sensitive.</p>
                </div>

                <div class="form-row full">
                  <label class="label" for="artworkImages">Artwork Images *</label>
                  <input id="artworkImages" class="input" type="file" accept="image/*" multiple required />
                  <p class="hint">Select one or more images of your artwork. Supported formats: JPG, PNG, GIF, WebP</p>
                </div>

                <div class="form-row full">
                  <label class="label" for="desc">Description</label>
                  <textarea id="desc" class="textarea" placeholder="Context, story, permissions, etc."></textarea>
                </div>
              </div>

              <div class="form-actions">
                <button class="btn btn-primary" type="submit" id="submit-btn">Submit</button>
                <a class="btn btn-secondary" href="account.html" id="back-btn">Back to Account</a>
              </div>
            </form>
            <p id="submit-note" class="page-description" style="margin-top:var(--space-md);display:none;"></p>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer" role="contentinfo">
      <div class="container">
        <div class="footer-bottom">
          <p class="footer-copyright">© Indigenous Art Atlas</p>
        </div>
      </div>
    </footer>

    <script src="user-auth.js"></script>
    <script type="module">
      import api from './api.js';
    </script>
    <script>
      const form = document.getElementById('artwork-form');
      const note = document.getElementById('submit-note');
      const sensitiveSel = document.getElementById('sensitive');
      const addressInput = document.getElementById('address');
      const addressNote = document.getElementById('address-note');
      const latInput = document.getElementById('latitude');
      const lngInput = document.getElementById('longitude');
      const coordsNote = document.getElementById('coords-note');
      const artworkImagesInput = document.getElementById('artworkImages');
      
      // Check if in edit mode
      const urlParams = new URLSearchParams(window.location.search);
      const isEditMode = urlParams.get('edit') === 'true';
      const artworkId = urlParams.get('id');
      let currentArtwork = null;

      function updateAddressState() {
        const isSensitive = sensitiveSel.value === 'true';
        addressInput.disabled = isSensitive;
        addressNote.style.display = isSensitive ? 'block' : 'none';
        latInput.disabled = isSensitive;
        lngInput.disabled = isSensitive;
        coordsNote.style.display = isSensitive ? 'block' : 'none';
        if (isSensitive) {
          addressInput.value = '';
          latInput.value = '';
          lngInput.value = '';
        }
      }
      sensitiveSel.addEventListener('change', updateAddressState);
      
      // Load artwork data if in edit mode
      async function loadArtworkForEdit() {
        if (!isEditMode || !artworkId) return;
        
        try {
          const api = await import('./api.js').then(m => m.default);
          currentArtwork = await api.getArtwork(artworkId);
          
          // Update page title
          document.getElementById('page-title').textContent = 'Edit Artwork';
          document.getElementById('page-description').textContent = 'Edit your pending artwork submission. Changes will be reviewed again by admins.';
          document.getElementById('submit-btn').textContent = 'Update Artwork';
          
          // Pre-populate form fields
          document.getElementById('title').value = currentArtwork.title || '';
          document.getElementById('artType').value = currentArtwork.type || 'Portrait';
          document.getElementById('period').value = currentArtwork.period || 'Contemporary';
          document.getElementById('region').value = currentArtwork.region || 'NSW';
          sensitiveSel.value = currentArtwork.sensitive ? 'true' : 'false';
          addressInput.value = currentArtwork.address || '';
          
          // Handle coordinates
          if (currentArtwork.coords) {
            latInput.value = currentArtwork.coords.lat || '';
            lngInput.value = currentArtwork.coords.lng || '';
          }
          
          document.getElementById('desc').value = currentArtwork.intro || '';
          
          // Make images optional in edit mode
          artworkImagesInput.required = false;
          
          updateAddressState();
        } catch (error) {
          console.error('Failed to load artwork:', error);
          alert('Failed to load artwork data. Redirecting back...');
          window.location.href = 'account.html';
        }
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        updateAddressState();
        loadArtworkForEdit();
      });

      // Popup notification function
      function showNotification(type, title, message, autoClose = true) {
        const overlay = document.createElement('div');
        overlay.className = 'notification-overlay';
        
        const popup = document.createElement('div');
        popup.className = `notification-popup notification-${type}`;
        
        const icon = type === 'success' ? '✅' : '❌';
        
        popup.innerHTML = `
          <div class="notification-icon">${icon}</div>
          <h3 class="notification-title">${title}</h3>
          <p class="notification-message">${message}</p>
          <button class="btn btn-primary" onclick="this.closest('.notification-overlay').remove()">OK</button>
        `;
        
        overlay.appendChild(popup);
        document.body.appendChild(overlay);
        
        // Auto close after 3 seconds if enabled
        if (autoClose) {
          setTimeout(() => {
            overlay.remove();
          }, 3000);
        }
        
        // Close on overlay click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.remove();
          }
        });
      }

      function isValidUrl(v){ try { new URL(v); return true; } catch { return false; } }
      function setValidity(el, ok, msg){
        el.setCustomValidity(ok ? '' : msg);
        if (!ok) el.reportValidity();
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get artist name from logged-in user
        const currentUser = JSON.parse(localStorage.getItem('atlas_user') || '{}');
        const artist = currentUser.name;
        
        // Validate that user is logged in and has a name
        if (!artist) {
          showNotification(
            'error',
            'Authentication Required',
            'You must be logged in as an artist to submit artwork.',
            false
          );
          return;
        }

        const title = document.getElementById('title').value.trim();
        const artType = document.getElementById('artType').value;
        const period = document.getElementById('period').value;
        const region = document.getElementById('region').value;
        const sensitive = sensitiveSel.value === 'true';
        const address = addressInput.value.trim();
        const lat = latInput.value.trim();
        const lng = lngInput.value.trim();
        const desc = document.getElementById('desc').value.trim();
        const artworkImages = artworkImagesInput.files;

        if (!title){ setValidity(document.getElementById('title'), false, 'Please enter the title.'); return; }
        if (!artworkImages || artworkImages.length === 0){ 
          setValidity(artworkImagesInput, false, 'Please select at least one artwork image.'); 
          return; 
        }
        setValidity(document.getElementById('title'), true, '');
        setValidity(artworkImagesInput, true, '');

        if (sensitive && address){
          setValidity(addressInput, false, 'Address cannot be provided when sensitive is true.'); 
          return;
        }
        
        if (sensitive && (lat || lng)){
          setValidity(latInput, false, 'Coordinates cannot be provided when sensitive is true.'); 
          return;
        }
        
        // Validate coordinates - both or neither
        if ((lat && !lng) || (!lat && lng)) {
          setValidity(lat ? lngInput : latInput, false, 'Please provide both latitude and longitude, or leave both empty.');
          return;
        }
        
        setValidity(addressInput, true, '');
        setValidity(latInput, true, '');
        setValidity(lngInput, true, '');

        // Import API module dynamically
        const api = await import('./api.js').then(m => m.default);

        // Disable submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading images...';

        try {
          // First, upload images to server
          let uploadedImages = [];
          if (artworkImages.length > 0) {
            const formData = new FormData();
            Array.from(artworkImages).forEach((file, index) => {
              formData.append('images[]', file);
            });

            const sessionId = localStorage.getItem('atlas_session_id');
            const uploadResponse = await fetch(`/cycle3/backend/upload.php?session_id=${sessionId}`, {
              method: 'POST',
              body: formData
            });

            const uploadResult = await uploadResponse.json();
            if (!uploadResult.success) {
              throw new Error(uploadResult.message || 'Image upload failed');
            }

            uploadedImages = uploadResult.data.files.map(f => ({
              name: f.name,
              size: f.size,
              type: f.type
            }));
          }

          submitBtn.textContent = 'Submitting artwork...';

          // Build coordinates object if both lat/lng provided
          const coords = (lat && lng) ? {
            lat: parseFloat(lat),
            lng: parseFloat(lng)
          } : null;

          const artworkData = {
            title, 
            artist, 
            type: artType,
            period, 
            region,
            sensitive, 
            address: address || null,
            coords: coords,
            intro: desc,
            artworkImages: uploadedImages
          };

          if (isEditMode && artworkId) {
            // Update existing artwork
            await api.updateArtwork(artworkId, artworkData, artist);
            
            // Show success popup
            showNotification(
              'success',
              'Artwork Updated!',
              'Your artwork has been updated successfully and will be reviewed again.',
              true
            );
            
            // Redirect to account page after a delay
            setTimeout(() => {
              window.location.href = 'account.html';
            }, 2000);
          } else {
            // Submit new artwork to backend
            await api.createArtwork(artworkData, artist);
            
            // Also save to localStorage for backwards compatibility
            const localData = {
              id: 'w_' + Math.random().toString(36).slice(2) + Date.now().toString(36),
              ...artworkData,
              status: 'pending',
              submittedAt: new Date().toISOString()
            };
            const key = 'IAA_artwork_submissions_v1';
            const arr = JSON.parse(localStorage.getItem(key) || '[]');
            arr.push(localData);
            localStorage.setItem(key, JSON.stringify(arr));

            // Show success popup
            showNotification(
              'success',
              'Artwork Submitted!',
              'Your artwork has been submitted successfully and is pending admin review.',
              true
            );
            
            form.reset();
            updateAddressState();
          }
        } catch (error) {
          console.error('Submission error:', error);
          
          // Show error popup
          showNotification(
            'error',
            'Submission Failed',
            error.message || 'An error occurred. Please try again.',
            false
          );
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Artwork';
        }
      });
    </script>
  </body>
</html>
<!--
#-# START COMMENT BLOCK #-#
AI Tool used: ChatGPT GPT-5 (OpenAI) via Cursor
AI-Acknowledgement.md line: 14
AI helped me complete the vast majority of lengthy, repetitive code. It significantly saved me time, allowing me to focus on bug fixes and multi-file code integration.
#-# END COMMENT BLOCK #-#
-->
